<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout | FAIDE®</title>
    <meta name="robots" content="noindex,nofollow" />
    <meta name="theme-color" content="#000000" />
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/style.css" />

    <!-- PayPal JS SDK
      IMPORTANT:
      - Put your real client-id here for PRODUCTION
      - or load it dynamically from your server if you prefer.
      If you don't want to expose it, you can set it in HTML manually via Vercel.
    -->
    <script>
      // If you want: hardcode your PayPal client id here.
      // window.PAYPAL_CLIENT_ID = "YOUR_CLIENT_ID";
    </script>
  </head>

  <body class="h-full w-full">
    <nav class="navbar">
      <a href="/#shop" aria-label="Back to shop" class="brand-link">
        <img src="/images/faide-wordmark.png" alt="FAIDE" class="faide-wordmark-img" />
      </a>

      <div class="nav-links" aria-label="Primary navigation">
        <a href="/#shop">SHOP</a>
        <a href="/#about">ABOUT</a>
      </div>

      <div class="nav-mobile-actions"></div>
    </nav>

    <main class="checkout-page">
      <div class="checkout-grid">
        <section class="checkout-card">
          <div class="checkout-title">Your Order</div>
          <div id="checkout-items" class="checkout-muted">Loading cart…</div>
          <div class="checkout-line"></div>
          <div class="checkout-row">
            <div class="checkout-muted">Total</div>
            <div class="checkout-total" id="checkout-total">R0.00</div>
          </div>

          <div class="checkout-line"></div>
          <div class="checkout-muted">
            Make sure your cart is correct. Payment is processed securely by PayPal (supports cards).
          </div>

          <div class="checkout-line"></div>
          <button id="checkout-whatsapp" class="secondary-btn" type="button">
            Checkout on WhatsApp instead
          </button>
        </section>

        <section class="checkout-card">
          <div class="checkout-title">Pay with Card</div>
          <div class="checkout-muted" style="margin-bottom:12px;">
            PayPal checkout supports debit/credit cards (even if customer doesn’t have PayPal).
          </div>

          <div id="paypal-area" class="checkout-muted">
            <span class="checkout-bad">PayPal not loaded yet.</span>
          </div>

          <div class="checkout-line"></div>
          <div id="paypal-status" class="checkout-muted"></div>

          <div class="checkout-line"></div>
          <a class="secondary-btn" href="/#shop">Continue Shopping</a>
        </section>
      </div>
    </main>

    <script>
      const CART_STORAGE_KEY = "faide_cart_v2";

      function loadCart() {
        try {
          const raw = localStorage.getItem(CART_STORAGE_KEY);
          const parsed = raw ? JSON.parse(raw) : [];
          return Array.isArray(parsed) ? parsed : [];
        } catch {
          return [];
        }
      }

      function moneyZAR(n) {
        const v = Number(n || 0);
        return `R${v.toFixed(2)}`;
      }

      async function loadProductsConfig() {
        const res = await fetch("/assets/js/products.json", { cache: "no-store" });
        return res.ok ? res.json() : { whatsappNumber: "27695603929" };
      }

      function renderCart(cart) {
        const host = document.getElementById("checkout-items");
        const totalEl = document.getElementById("checkout-total");

        if (!host || !totalEl) return;

        if (!cart.length) {
          host.innerHTML = '<span class="checkout-bad">Your cart is empty.</span> <a href="/#shop">Go to shop</a>';
          totalEl.textContent = moneyZAR(0);
          return { total: 0 };
        }

        let total = 0;
        const lines = cart.map((it) => {
          const lineTotal = (Number(it.price) || 0) * (Number(it.quantity) || 0);
          total += lineTotal;
          return `<div style="display:flex; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.06);">
            <div style="min-width:0;">
              <div style="color:#fff; font-weight:900;">${it.name}</div>
              <div class="checkout-muted">Size: ${it.size} • Color: ${it.color} • Qty: ${it.quantity}</div>
            </div>
            <div style="color:#fff; font-weight:900; white-space:nowrap;">${moneyZAR(lineTotal)}</div>
          </div>`;
        });

        host.innerHTML = lines.join("");
        totalEl.textContent = moneyZAR(total);
        return { total };
      }

      function checkoutOnWhatsApp(cart, whatsappNumber) {
        if (!cart.length) return;

        const lines = ["Hi FAIDE, I want to place an order:", ""];
        let total = 0;

        cart.forEach((item, i) => {
          const lineTotal = (Number(item.price) || 0) * (Number(item.quantity) || 0);
          total += lineTotal;
          lines.push(
            `${i + 1}) ${item.name} | Size: ${item.size} | Color: ${item.color} | Qty: ${item.quantity} | ${moneyZAR(lineTotal)}`
          );
        });

        lines.push("", `TOTAL: ${moneyZAR(total)}`, "", "Name:", "(Type here)", "", "Delivery address:", "(Type here)");

        window.open(`https://wa.me/${whatsappNumber}?text=${encodeURIComponent(lines.join("\n"))}`, "_blank", "noopener,noreferrer");
      }

      async function loadPayPalScript(clientId) {
        return new Promise((resolve, reject) => {
          if (!clientId) return reject(new Error("Missing PayPal client id"));
          if (window.paypal) return resolve(true);

          const s = document.createElement("script");
          s.src = `https://www.paypal.com/sdk/js?client-id=${encodeURIComponent(clientId)}&currency=ZAR&intent=capture`;
          s.async = true;
          s.onload = () => resolve(true);
          s.onerror = () => reject(new Error("Failed to load PayPal SDK"));
          document.head.appendChild(s);
        });
      }

      async function main() {
        const config = await loadProductsConfig();
        const cart = loadCart();

        const { total } = renderCart(cart);

        document.getElementById("checkout-whatsapp")?.addEventListener("click", () => {
          checkoutOnWhatsApp(cart, config.whatsappNumber || "27695603929");
        });

        const paypalArea = document.getElementById("paypal-area");
        const statusEl = document.getElementById("paypal-status");

        if (!cart.length) {
          if (paypalArea) paypalArea.innerHTML = '<span class="checkout-bad">Add items to your cart first.</span>';
          return;
        }

        // You can hardcode PayPal client ID here for now:
        // IMPORTANT: replace with your real client id (sandbox or live)
        const clientId = window.PAYPAL_CLIENT_ID || "REPLACE_WITH_YOUR_PAYPAL_CLIENT_ID";

        try {
          await loadPayPalScript(clientId);
        } catch (e) {
          if (paypalArea) paypalArea.innerHTML = `<span class="checkout-bad">${e.message}</span>`;
          return;
        }

        if (paypalArea) paypalArea.innerHTML = `<div id="paypal-buttons"></div>`;

        // Use your API routes:
        // POST /api/paypal-create-order  -> returns { id: "ORDER_ID" }
        // POST /api/paypal-capture-order -> returns capture result
        window.paypal
          .Buttons({
            style: {
              layout: "vertical",
              shape: "pill"
            },
            createOrder: async () => {
              statusEl.textContent = "Creating order…";
              const res = await fetch("/api/paypal-create-order", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  currency: "ZAR",
                  cart,
                  total
                })
              });
              const data = await res.json();
              if (!res.ok) throw new Error(data?.error || "Failed to create order");
              statusEl.textContent = "Order created. Continue payment…";
              return data.id;
            },
            onApprove: async (data) => {
              statusEl.textContent = "Capturing payment…";
              const res = await fetch("/api/paypal-capture-order", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ orderID: data.orderID })
              });
              const result = await res.json();
              if (!res.ok) throw new Error(result?.error || "Capture failed");

              statusEl.innerHTML = `<span class="checkout-good">Payment successful.</span> Redirecting…`;
              localStorage.removeItem(CART_STORAGE_KEY);
              window.location.href = "/success.html";
            },
            onCancel: () => {
              statusEl.innerHTML = `<span class="checkout-bad">Payment cancelled.</span>`;
              window.location.href = "/cancel.html";
            },
            onError: (err) => {
              console.error(err);
              statusEl.innerHTML = `<span class="checkout-bad">Payment error. Try again or use WhatsApp checkout.</span>`;
            }
          })
          .render("#paypal-buttons");
      }

      main();
    </script>
  </body>
</html>